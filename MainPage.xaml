<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MauiApp1.MainPage"
             xmlns:local="clr-namespace:MauiApp1"
             xmlns:controls="clr-namespace:MauiApp1.Controls"
             x:Name="RootPage"
             BackgroundColor="#F2F2F2"
             Padding="20,0,50,650">

    <CollectionView ItemsSource="{Binding Products}"
                    HeightRequest="240"
                    SelectionMode="None">

        <CollectionView.ItemsLayout>
            <GridItemsLayout Orientation="Vertical"
                         Span="8"   VerticalItemSpacing="16" HorizontalItemSpacing="16" />
        </CollectionView.ItemsLayout>

        <CollectionView.ItemTemplate>
            <DataTemplate>
                <!-- Outer Grid controls layering -->
                <Grid HeightRequest="240" WidthRequest="140">

                    <!-- Card with hover (clipped) -->
                    <ContentView HeightRequest="200"
                                 WidthRequest="140"
                                 VerticalOptions="End"
                                 ZIndex="0">
                        <ContentView.Clip>
                            <RoundRectangleGeometry CornerRadius="7"
                                                    Rect="0,0,140,200"/>
                        </ContentView.Clip>

                        <!-- Hover states -->
                        <VisualStateManager.VisualStateGroups>
                            <VisualStateGroup Name="CommonStates">
                                <VisualState Name="Normal">
                                    <VisualState.Setters>
                                        <Setter Property="BackgroundColor" Value="White" />
                                    </VisualState.Setters>
                                </VisualState>
                                <VisualState Name="PointerOver">
                                    <VisualState.Setters>
                                        <Setter Property="BackgroundColor" Value="#E4E2E2" />
                                    </VisualState.Setters>
                                </VisualState>
                            </VisualStateGroup>
                        </VisualStateManager.VisualStateGroups>

                        <!-- Inner card -->
                        <Border Stroke="#D1D1D1"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 7"
                                BackgroundColor="Transparent"
                                Padding="12">
                            <Grid RowDefinitions="*,Auto">
                                <!-- Title -->
                                <Label Grid.Row="0"
                                       Text="{Binding Title}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       HorizontalTextAlignment="Center"
                                       VerticalTextAlignment="Start"
                                       LineBreakMode="WordWrap"
                                       MaxLines="2"             
                                    HeightRequest="50"
                                  Margin="8,3,4,0" />

                                    <!-- Price -->
                                <Grid Grid.Row="1"
                                      ColumnDefinitions="*,Auto"
                                      VerticalOptions="End"
                                      Margin="10,10,5,-2">
                                    <Label Grid.Column="1"
                                           
                                           Text="{Binding Price, StringFormat='€ {0:0.00}'}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           HorizontalOptions="End" />
                                </Grid>
                            </Grid>
                        </Border>

                        <!-- Tap Gesture instead of Button -->
                        <ContentView.GestureRecognizers>
                            <TapGestureRecognizer 
                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:MainPage}}, Path=BindingContext.IncreaseQuantityCommand}"
                                CommandParameter="{Binding .}" />
                        </ContentView.GestureRecognizers>
                    </ContentView>

                    <!-- Product Circle (overlaps card) -->
                    <Border HeightRequest="80"
                            WidthRequest="80"
                            BackgroundColor="White"
                            Stroke="#CCCCCC"
                            StrokeThickness="1"
                            Padding="4"
                            HorizontalOptions="Center"
                            VerticalOptions="Start"
                            Margin="0,10,0,0"
                            ZIndex="2">
                        <Border.StrokeShape>
                            <Ellipse />
                        </Border.StrokeShape>
                        <Image Source="{Binding Image}"
                               Aspect="AspectFill"
                               HeightRequest="45"
                               WidthRequest="66"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
                    </Border>

                    <!--  Ribbon (switches side based on color) -->
                    <controls:RibbonView RibbonColor="{Binding RibbonColor}"
                                         HeightRequest="50"
                                         WidthRequest="30"
                                         VerticalOptions="Start"
                                         HorizontalOptions="End"
                                         Margin="0,40,0,0"
                                         ZIndex="1">
                        <controls:RibbonView.Triggers>
                            <!-- If Green, move to left -->
                            <DataTrigger TargetType="controls:RibbonView"
                                         Binding="{Binding RibbonColor}"
                                         Value="#8BC34A">
                                <Setter Property="HorizontalOptions" Value="Start" />
                                <Setter Property="Margin" Value="0,40,0,0" />
                                
                            </DataTrigger>
                        </controls:RibbonView.Triggers>
                    </controls:RibbonView>

                    <!-- Quantity badge with basket -->
                    <Grid HorizontalOptions="Start"
                          VerticalOptions="End"
                          Margin="18,2,1,12"
                          ZIndex="2">

                        <!-- Hide badge if Quantity = 0 -->
                        <Grid.Triggers>
                            <DataTrigger TargetType="Grid" Binding="{Binding Quantity}" Value="0">
                                <Setter Property="IsVisible" Value="False" />
                            </DataTrigger>
                        </Grid.Triggers>

                        <!-- Basket Icon -->
                        <Image Source="basket.png"
                               Aspect="AspectFit"
                               WidthRequest="34"
                               HeightRequest="34" />

                        <!-- Quantity Overlay -->
                        <Label Text="{Binding Quantity}"
                               TextColor="White"
                               FontSize="12"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               VerticalTextAlignment="Center"
                               Margin="0,8,0,0" />
                    </Grid>

                </Grid>
            </DataTemplate>
        </CollectionView.ItemTemplate>
    </CollectionView>
</ContentPage>
